name: Android APK
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          java-version: '21'

      # Διαγνωστικά περιβάλλοντος
      - name: Diagnostics
        run: |
          echo "PWD=$(pwd)"
          ls -la
          which flutter || true
          flutter --version
          dart --version
          echo "=== lib/ listing ==="; ls -la lib || true
          echo "=== pubspec.yaml ==="; sed -n '1,200p' pubspec.yaml || true

      # Επιβεβαίωση δομής έργου στη ρίζα
      - name: Verify project structure
        run: |
          test -f pubspec.yaml || (echo 'ERROR: pubspec.yaml not found in repo root' >&2; exit 1)
          test -f lib/main.dart || (echo 'ERROR: lib/main.dart not found in repo root' >&2; exit 1)

      - name: Flutter clean & pub get
        run: |
          flutter clean
          flutter pub get --verbose

      # Χτίσιμο με Flutter CLI, ρητός entrypoint. Αν αποτύχει, fallback σε Gradle (αν υπάρχει)
      - name: Build APK (Flutter, then Gradle fallback)
        run: |
          set -e
          echo "=== Flutter build (release, entrypoint lib/main.dart) ==="
          if flutter build apk -t lib/main.dart --release --no-tree-shake-icons --verbose; then
            echo "Flutter build OK."
          else
            echo "Flutter build failed. Trying Gradle fallback if wrapper exists..." >&2
            if [ -x android/gradlew ]; then
              (cd android && ./gradlew assembleRelease --no-daemon --stacktrace)
            else
              echo "No Gradle wrapper found (android/gradlew missing). Failing." >&2
              exit 1
            fi
          fi

      - name: List APKs
        run: |
          echo "=== APKs found under repo ==="
          find . -type f -name "*.apk" -print || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            build/**/outputs/**/*.apk
            build/**/*.apk
            android/app/build/outputs/**/*.apk
          if-no-files-found: error
